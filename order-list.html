<!DOCTYPE html>
<html lang="mn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Solned  –∞–ª–±–∞–Ω —ë—Å–Ω—ã —É—Ä–∞–Ω –±“Ø—Ç—ç—ç–ª—á–∏–π–Ω —Ç–∞–Ω–∏–ª—Ü—É—É–ª–≥–∞,–∑–∞—Ö–∏–∞–ª–≥–∞, –∞–∂–∏–ª–∞—Ö –±“Ø—Å, –º—ç–¥—ç—ç –º—ç–¥—ç—ç–ª—ç–ª –±“Ø—Ö–∏–π –≤–µ–± —Å–∞–π—Ç.">
  <meta name="author" content="Solned –°–æ–¥–±–∞—è—Ä, –ú”©–Ω—Ö—Å–∞–π—Ö–∞–Ω, –¢—ç–ª–º—ç–Ω">
  <link rel="icon" type="image/png" href="./picture/icons/–õ–æ–≥–æ.png">
    <title>–ó–∞—Ö–∏–∞–ª–≥–∞ —à–∞–ª–≥–∞—Ö | Solned</title>
    <link rel="stylesheet" href="./styles/global.css" />
    <link rel="stylesheet" href="./styles/Footer.css" />
    <link rel="stylesheet" href="./styles/orderlist.css" />
    <link rel="stylesheet" href="./styles/login-header.css" />
    <script type="module" src="./component1/neriin.js"></script>
    <script type="text/javascript" src="./js/darkmode.js" defer></script>
    <script src="./js/auth.js"></script>
  <script src="./js/header.js"></script>
  </head>

  <body>
    <header>
      <button id="theme-switch">
        <p>üåë</p>
        <p>‚òÄÔ∏è</p>
      </button>
      <nav>
        <ul>
          <li class="logo">
            <a href="Nuur.html">
              <img alt="logo" src="./picture/logo.png " />
            </a>
          </li>
          <li class="searchbar">
            <form action="/search" method="GET">
              <input
                type="text"
                name="search"
                id="search"
                placeholder="–•–∞–π–ª—Ç —Ö–∏–π—Ö..."
                aria-label="Search"
              />
              <button type="submit" class="search-btn">
                üîç
              </button>
            </form>
          </li>        
          <li class="checkorder">
            <a href="./check-order.html">üßæ–ó–∞—Ö–∏–∞–ª–≥–∞ —à–∞–ª–≥–∞—Ö</a>
          </li>
          <li class="login"><a href="login.html">–ù—ç–≤—Ç—Ä—ç—Ö</a></li>
        </ul>
      </nav>
    </header>

    <main id="Zahialaga">
      <p id="loading" class="loading">–£–Ω—à–∏–∂ –±–∞–π–Ω–∞...</p>
      <p id="Aldaa" class="error" style="display: none"></p>
      <section id="Zmedeelel"></section>
      <article id="cancelModal" class="modal" style="display: none">
        <div class="modal-content">
          <h2>–ó–∞—Ö–∏–∞–ª–≥–∞ —Ü—É—Ü–ª–∞—Ö</h2>
          <p>–¢–∞ –∑–∞—Ö–∏–∞–ª–≥–∞–∞ —Ü—É—Ü–ª–∞—Ö–¥–∞–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?</p>
          <div class="modal-buttons">
            <button class="modal-btn cancel-modal-btn" onclick="closeModal()">
              “Æ–≥“Ø–π
            </button>
            <button class="modal-btn confirm-btn" onclick="confirmCancel()">
              –¢–∏–π–º
            </button>
          </div>
        </div>
      </article>
    </main>

    <footer>
      <section class="social-address">
        <a href="Nuur.html">
          <img src="./picture/logo.png " width="30" alt="Company logo" />
        </a>
        <section>
          <img src="picture/icons//facebook.png" alt="facebook" />
          <img src="picture/icons/instagram.png" alt="facebook" />
        </section>
  
        <a href="https://www.apple.com/app-store/">
          <button>
            <img src="picture/icons/play.png" alt="Apple Store" />
            <p>Playstore-–æ–æ—Å —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö</p>
          </button>
        </a>
  
        <a href="https://play.google.com/store">
          <button>
            <img src="picture/icons//apple.png" alt="Apple Store" />
            <p>Appstore-–æ–æ—Å —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö</p>
          </button>
        </a>
      </section>
      <section class="about-us">
        <ul>
          <li>
            <h2>SOLNED</h2>
          </li>
          <li>
            <a href="#">–ë–∏–¥–Ω–∏–π —Ç—É—Ö–∞–π</a>
          </li>
          <li>
            <a href="#">–¢—É—Å–ª–∞–º–∂</a>
          </li>
        </ul>
        <ul>
          <li>
            <h2>–•–û–õ–ë–û–û –ë–ê–†–ò–•</h2>
          </li>
          <li>
            <a href="gmail.com">Solned@gmail.com</a>
          </li>
          <li>
            <a>–û—Ñ—Ñ–∏—Å, –ß–∏–Ω–≥—ç–ª—Ç—ç–π</br /> –¥“Ø“Ø—Ä—ç–≥ 6-—Ö–æ—Ä–æ–æ, </br />53 –±–∞–π—Ä</a>
          </li>
        </ul>
      </section>
    </footer>
    <script>
      let currentOrderId = null;

      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const orderCode = urlParams.get("orderNumber");

        if (orderCode) {
          fetchOrderDetails(orderCode);
        }
      });

      async function fetchOrderDetails(orderCode) {
        try {
          const response = await fetch(
            `http://localhost:3000/api/orders/check/${orderCode}`
          );
          const data = await response.json();

          document.getElementById("loading").style.display = "none";

          if (data.success && data.data) {
            displayOrderDetails(data.data);
          } else {
            showError("–ó–∞—Ö–∏–∞–ª–≥–∞ –æ–ª–¥—Å–æ–Ω–≥“Ø–π. –ë—É—Ü–∞–∞–¥ —à–∞–ª–≥–∞–Ω–∞ —É—É.");
          }
        } catch (error) {
          showError("–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –ë—É—Ü–∞–∞–¥ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.");
        }
      }

      function showError(message) {
        const Aldaa = document.getElementById("Aldaa");
        Aldaa.textContent = message;
        Aldaa.style.display = "block";
      }

      function displayOrderDetails(order) {
        currentOrderId = order.id;
        const container = document.getElementById("Zmedeelel");

        const statusText = {
          pending: "–•“Ø–ª—ç—ç–≥–¥—ç–∂ –±–∞–π–Ω–∞",
          cancelled: "–¶—É—Ü–ª–∞–≥–¥—Å–∞–Ω",
          completed: "–î—É—É—Å—Å–∞–Ω",
        };

        const html = `
                <div class="order-card">
                  <artist-profile artist-id="${order.event.artistId}"></artist-profile>
                    <div class="order-header">
                        <h2>–ó–∞—Ö–∏–∞–ª–≥—ã–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π</h2>
                        <span class="status-badge status-${order.status}">
                            ${statusText[order.status] || order.status}
                        </span>
                    </div>
                    <div class="order-details">
                        <div>
                            <div class="detail-group">
                                <div class="detail-label">–ó–∞—Ö–∏–∞–ª–≥—ã–Ω –∫–æ–¥:</div>
                                <div>${order.orderCode}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">–ó–∞—Ö–∏–∞–ª–∞–≥—á:</div>
                                <div>${order.customerName}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">–ù–∏–π—Ç –¥“Ø–Ω:</div>
                                <div>${order.totalAmount}‚ÇÆ</div>
                            </div>
                        </div>
                        <div>
                            <div class="detail-group">
                                <div class="detail-label">–ê—Ä–≥–∞ —Ö—ç–º–∂—ç—ç–Ω–∏–π –æ–≥–Ω–æ–æ:</div>
                                <div>${new Date(
                                  order.event.date
                                ).toLocaleDateString()}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">–•—ç—Ä—ç–≥—Ç—ç–π —Ö—É–≥–∞—Ü–∞–∞:</div>
                                <div>${order.event.artistAvailability}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">–ë–∞–π—Ä—à–∏–ª:</div>
                                <div>${order.event.location}</div>
                            </div>
                        </div>
                    </div>
                    ${
                      order.status === "pending"
                        ? `<button class="cancel-btn" onclick="showCancelModal()">–ó–∞—Ö–∏–∞–ª–≥–∞ —Ü—É—Ü–ª–∞—Ö</button>`
                        : ""
                    }
                </div>
            `;

        container.innerHTML = html;
      }

      function showCancelModal() {
        document.getElementById("cancelModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("cancelModal").style.display = "none";
      }

      async function confirmCancel() {
        try {
          const orderCode = new URLSearchParams(window.location.search).get(
            "orderNumber"
          );
          const response = await fetch(
            `http://localhost:3000/api/orders/cancel/${orderCode}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: "cancelled" }),
            }
          );

          if (response.ok) {
            await fetchOrderDetails(orderCode);
          } else {
            showError("–ó–∞—Ö–∏–∞–ª–≥–∞ —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞");
          }
        } catch (error) {
          showError("–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞");
        } finally {
          closeModal();
        }
      }

      window.onclick = function (event) {
        const modal = document.getElementById("cancelModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
