<!DOCTYPE html>
<html lang="mn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Захиалга шалгах | Solned</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="./styles/Footer.css" />
    <link rel="stylesheet" href="./styles/zahialagbatalgaa.css" />
    <script type="text/javascript" src="./js/darkmode.js" defer></script>
  </head>

  <body>
    <header>
      <button id="theme-switch">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="currentColor"
        >
          <path
            d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"
          />
        </svg>
      </button>
      <nav>
        <ul>
          <li class="logo">
            <a href="Nuur.html">
              <img alt="logo" src="./picture/logo.png" />
            </a>
          </li>
          <li class="searchbar">
            <form action="/search" method="GET">
              <input
                type="text"
                name="search"
                id="search"
                placeholder="Хайлт хийх..."
                aria-label="Search"
              />
            </form>
          </li>
          <li class="checkorder">
            <a href="check-order.html">Захиалга шалгах</a>
          </li>
          <li class="login"><a href="login.html">Нэвтрэх</a></li>
        </ul>
      </nav>
    </header>

    <main id="mainContent">
      <div id="loadingIndicator" class="loading">Loading...</div>
      <div id="errorContainer" class="error" style="display: none"></div>
      <div id="orderContainer"></div>

      <!-- Cancel Confirmation Modal -->
      <div id="cancelModal" class="modal" style="display: none">
        <div class="modal-content">
          <h2>Захиалга цуцлах</h2>
          <p>Та захиалгаа цуцлахдаа итгэлтэй байна уу?</p>
          <div class="modal-buttons">
            <button class="modal-btn cancel-modal-btn" onclick="closeModal()">
              Үгүй
            </button>
            <button class="modal-btn confirm-btn" onclick="confirmCancel()">
              Тийм
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <section class="social-address">
        <a href="Nuur.html">
          <img src="picture/logo.PNG" width="30" alt="Company logo" />
        </a>
        <section>
          <img src="picture/icons/facebook.png" alt="Facebook" />
          <img src="picture/icons/instagram.png" alt="Instagram" />
        </section>

        <a href="https://www.apple.com/app-store/">
          <button>
            <img src="picture/icons/apple.png" alt="Apple Store" />
            <p>App Store-оос татаж авах</p>
          </button>
        </a>

        <a href="https://play.google.com/store">
          <button>
            <img src="picture/icons/apple.png" alt="Google Play" />
            <p>Play Store-оос татаж авах</p>
          </button>
        </a>
      </section>
      <section class="about-us">
        <ul>
          <li>
            <h2>SOLNED</h2>
          </li>
          <li><a href="#">Бидний тухай</a></li>
          <li><a href="#">Тусламж</a></li>
        </ul>
        <ul>
          <li>
            <h2>ХОЛБОО БАРИХ</h2>
          </li>
          <li><a href="mailto:solned@gmail.com">Solned@gmail.com</a></li>
          <li>
            <address>Оффис, Чингэлтэй дүүрэг 6-хороо, 53 байр</address>
          </li>
        </ul>
      </section>
    </footer>

    <script>
      let currentOrderId = null;

      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const orderCode = urlParams.get("orderNumber");

        if (orderCode) {
          fetchOrderDetails(orderCode);
        }
      });

      async function fetchOrderDetails(orderCode) {
        try {
          const response = await fetch(
            `http://localhost:3000/api/orders/check/${orderCode}`
          );
          const data = await response.json();

          document.getElementById("loadingIndicator").style.display = "none";

          if (data.success && data.data) {
            displayOrderDetails(data.data);
          } else {
            showError("Захиалга олдсонгүй. Буцаад шалгана уу.");
          }
        } catch (error) {
          showError("Алдаа гарлаа. Буцаад дахин оролдоно уу.");
        }
      }

      function showError(message) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.textContent = message;
        errorContainer.style.display = "block";
      }

      function displayOrderDetails(order) {
        currentOrderId = order.id;
        const container = document.getElementById("orderContainer");

        const statusText = {
          pending: "Хүлээгдэж байна",
          cancelled: "Цуцлагдсан",
          completed: "Дууссан",
        };

        const html = `
                <div class="order-card">
                    <div class="order-header">
                        <h2>Захиалгын дэлгэрэнгүй</h2>
                        <span class="status-badge status-${order.status}">
                            ${statusText[order.status] || order.status}
                        </span>
                    </div>
                    <div class="order-details">
                        <div>
                            <div class="detail-group">
                                <div class="detail-label">Захиалгын код:</div>
                                <div>${order.orderCode}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Захиалагч:</div>
                                <div>${order.customerName}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Нийт дүн:</div>
                                <div>${order.totalAmount}₮</div>
                            </div>
                        </div>
                        <div>
                            <div class="detail-group">
                                <div class="detail-label">Арга хэмжээний огноо:</div>
                                <div>${new Date(
                                  order.event.date
                                ).toLocaleDateString()}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Хэрэгтэй хугацаа:</div>
                                <div>${order.event.artistAvailability}</div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-label">Байршил:</div>
                                <div>${order.event.location}</div>
                            </div>
                        </div>
                    </div>
                    ${
                      order.status === "pending"
                        ? `<button class="cancel-btn" onclick="showCancelModal()">Захиалга цуцлах</button>`
                        : ""
                    }
                </div>
            `;

        container.innerHTML = html;
      }

      function showCancelModal() {
        document.getElementById("cancelModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("cancelModal").style.display = "none";
      }

      async function confirmCancel() {
        try {
          const orderCode = new URLSearchParams(window.location.search).get(
            "orderNumber"
          );
          const response = await fetch(
            `http://localhost:3000/api/orders/cancel/${orderCode}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: "cancelled" }),
            }
          );

          if (response.ok) {
            await fetchOrderDetails(orderCode);
          } else {
            showError("Захиалга цуцлахад алдаа гарлаа");
          }
        } catch (error) {
          showError("Алдаа гарлаа");
        } finally {
          closeModal();
        }
      }

      window.onclick = function (event) {
        const modal = document.getElementById("cancelModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
